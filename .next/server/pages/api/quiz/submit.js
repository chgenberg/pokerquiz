"use strict";(()=>{var e={};e.id=835,e.ids=[835],e.modules={1247:(e,t,n)=>{n.r(t),n.d(t,{config:()=>P,default:()=>c,routeModule:()=>p});var r={};n.r(r),n.d(r,{default:()=>f});var i=n(3480),a=n(8667),u=n(6435),s=n(6330);let o=require("ioredis"),d=new s.PrismaClient,l=process.env.REDIS_URL?new o.Redis(process.env.REDIS_URL):new o.Redis;async function f(e,t){if("POST"!==e.method)return t.status(405).end();let{batchId:n,userId:r,answers:i,totalMs:a,region:u}=e.body;if(!n||!r||!i||"number"!=typeof a||!u)return t.status(400).json({error:"Missing fields"});let s=await d.quizBatch.findUnique({where:{id:n}});if(!s)return t.status(404).json({error:"Batch not found"});if(new Date>s.validTo)return t.status(400).json({error:"Quiz expired"});let o=s.questions;if(i.length!==o.length)return t.status(400).json({error:"Wrong number of answers"});let f=0;i.forEach((e,t)=>{e===o[t].correctIndex&&f++}),await d.quizRun.create({data:{userId:r,batchId:n,score:f,timeStampMs:a}});let c=`lb:${n}:${s.difficulty}:${u}`,P=1e6*f-a;await l.zadd(c,P,r);let p=`lb:${n}:${s.difficulty}:ALL`;await l.zadd(p,P,r);let m=`streak:${r}`,w=1,A=await l.get(m),g=new Date().toISOString().slice(0,10);if(A){let e=(new Date(g).getTime()-new Date(A).getTime())/864e5;w=1===e?(Number(await l.get(`${m}:count`))||1)+1:0===e&&Number(await l.get(`${m}:count`))||1}await l.set(m,g),await l.set(`${m}:count`,w);let b=f===o.length;t.json({score:f,streak:w,flawless:b})}let c=(0,u.M)(r,"default"),P=(0,u.M)(r,"config"),p=new i.PagesAPIRouteModule({definition:{kind:a.A.PAGES_API,page:"/api/quiz/submit",pathname:"/api/quiz/submit",bundlePath:"",filename:""},userland:r})},3480:(e,t,n)=>{e.exports=n(5600)},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6330:e=>{e.exports=require("@prisma/client")},6435:(e,t)=>{Object.defineProperty(t,"M",{enumerable:!0,get:function(){return function e(t,n){return n in t?t[n]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,n)):"function"==typeof t&&"default"===n?t:void 0}}})},8667:(e,t)=>{Object.defineProperty(t,"A",{enumerable:!0,get:function(){return n}});var n=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var n=t(t.s=1247);module.exports=n})();